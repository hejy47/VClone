{"Source Block": ["amiga2000-gfxcard/z2-minispartan/z2.v@710:836@HdlStmProcess", "    videocap_x2 <= videocap_x2 + 1'b1;\n    videocap_buf2[videocap_x2-videocap_prex] <= videocap_rgbin2;\n  end\nend\n\nalways @(posedge z_sample_clk) begin\n  znUDS_sync  <= {znUDS_sync[1:0],znUDS};\n  znLDS_sync  <= {znLDS_sync[1:0],znLDS};\n  znAS_sync   <= {znAS_sync[1:0],znAS};\n  zREAD_sync  <= {zREAD_sync[1:0],zREAD};\n  \n  znDS1_sync  <= {znDS1_sync[1:0],znDS1};\n  znDS0_sync  <= {znDS0_sync[1:0],znDS0};\n  zDOE_sync   <= {zDOE_sync[0],zDOE};\n  zE7M_sync   <= {zE7M_sync[3:0],zE7M};\n  znRST_sync  <= {znRST_sync[0],znRST};\n  znCFGIN_sync  <= {znCFGIN_sync[1:0],znCFGIN};\n  znFCS_sync <= {znFCS_sync[1:0],znFCS};\n  \n  // unused signals ------------------------------------\n  SD_DAT1_sync <= SD_DAT1;\n  SD_DAT2_sync <= SD_DAT2;\n  zFC0_sync <= zFC0;\n  zFC1_sync <= zFC1;\n  zFC2_sync <= zFC2;\n  zSENSEZ3_sync <= zSENSEZ3;\n  znBERR_sync <= znBERR;\n  \n  // Z2 ------------------------------------------------\n  z2_addr_valid <= (znAS_sync[2]==0);\n  \n  data_in <= zD;\n  zdata_in_sync <= data_in;\n  \n  need_row_fetch_y_latched <= need_row_fetch_y;\n  \n  zaddr <= {zA[22:0],1'b0};\n  zaddr_sync  <= zaddr;\n  zaddr_sync2 <= zaddr_sync;\n  \n  z2_mapped_addr <= ((zaddr_sync2-ram_low)>>1);\n  z2_read  <= (zREAD_sync[0] == 1'b1);\n  z2_write <= (zREAD_sync[0] == 1'b0);\n  \n  datastrobe_synced <= (znUDS_sync==0 || znLDS_sync==0);\n  z2_uds <= (znUDS_sync==0);\n  z2_lds <= (znLDS_sync==0);\n  \n  // CHECK\n  zaddr_in_ram <= (zaddr_sync==zaddr_sync2 && zaddr_sync2>=ram_low && zaddr_sync2<ram_high);\n  zaddr_in_reg <= (zaddr_sync==zaddr_sync2 && zaddr_sync2>=reg_low && zaddr_sync2<reg_high);\n  if (znAS_sync[1]==0 && zaddr_sync2>=autoconf_low && zaddr_sync2<autoconf_high)\n    zaddr_autoconfig <= 1'b1;\n  else\n    zaddr_autoconfig <= 1'b0;\n  \n  // Z3 ------------------------------------------------\n  z3addr2 <= {zD[15:8],zA[22:1],2'b00};\n  //z3addr2 <= {zD[15:8],zaddr[23:2],2'b00};\n  \n  // sample z3addr on falling edge of /FCS\n  if (z3_fcs_state==0) begin\n    if (znFCS_sync[0]==1 /*3'b111*/) begin\n      z3_fcs_state <= 1;\n      z3_end_cycle <= 1;\n      z3addr <= 0; \n    end\n  end else\n  if (z3_fcs_state==1) begin\n    if (znFCS_sync[0]==0 /*3'b000*/) begin // CHECK: if responding too quickly, this causes crashes\n      z3_fcs_state <= 0;\n      z3_end_cycle <= 0;\n      z3addr <= z3addr2;\n      zorro_read  <= zREAD_sync[1];\n      zorro_write  <= ~zREAD_sync[1];\n    end\n  end\n  \n  if (z3_fcs_state==0) begin\n    z3addr_in_ram <= (z3addr >= z3_ram_low) && (z3addr < z3_ram_high);\n    z3addr_in_reg <= (z3addr >= z3_reg_low) && (z3addr < z3_reg_high);\n  end else begin\n    z3addr_in_ram <= 0;\n    z3addr_in_reg <= 0;\n  end\n  \n  z3addr_autoconfig <= (z3addr[31:16]=='hff00);\n  \n  z3_mapped_addr <= (z3addr-z3_ram_low)>>1;\n  data_in_z3_low16 <= zaddr[23:8]; //zA[22:7]; // FIXME why sample this twice?\n  \n  //if (znUDS_sync==3'b000 || znLDS_sync==3'b000 || znDS1_sync==3'b000 || znDS0_sync==3'b000)\n  if (znUDS_sync[1]==0 || znLDS_sync[1]==0 || znDS1_sync[1]==0 || znDS0_sync[1]==0)\n    z3_din_latch <= 1;\n  else\n    z3_din_latch <= 0;\n\n  //z3_end_cycle <= (z3_fcs_state==1); //(znFCS_sync[0]==1); //(znFCS_sync==3'b111);\n  \n  // pipelined for better timing\n  if (z3_din_latch) begin\n    z3_din_high_s2 <= data_in; //zD;\n    z3_din_low_s2  <= data_in_z3_low16; //zA[22:7];\n  end\n  \n  // pipelined for better timing\n  data_z3_hi16_latched <= data_z3_hi16;\n  data_z3_low16_latched <= data_z3_low16;\n  dataout_z3_latched <= dataout_z3;\n  dtack_latched <= dtack;\n  \n  // RESET, CONFIG\n  z_reset <= (znRST_sync==3'b000);\n  z_cfgin <= (znCFGIN_sync==3'b000);\n  z_cfgin_lo <= (znCFGIN_sync==3'b111);\n  \n  // SD sync\n  sd_handshake_out_sync <= sd_handshake_out;\n  sd_data_out_sync <= sd_data_out;\n  sd_busy_sync <= sd_busy;\n  sd_error_sync <= sd_error;\nend\n\n// ram arbiter\nreg zorro_ram_read_request = 0;\nreg zorro_ram_read_done = 1;\nreg zorro_ram_write_request = 0;\n"], "Clone Blocks": [], "Diff Content": {"Delete": [[744, "  need_row_fetch_y_latched <= need_row_fetch_y;\n"]], "Add": [[744, "  if (videocap_mode) begin\n"], [744, "    if (need_row_fetch_y>((vga_screen_h>>vga_scalemode_v) - videocap_interlace)) // FIXME sync\n"], [744, "      need_row_fetch_y_latched <= 1;\n"], [744, "    else\n"], [744, "      need_row_fetch_y_latched <= need_row_fetch_y+1'b1;\n"], [744, "  end else\n"], [744, "    need_row_fetch_y_latched <= need_row_fetch_y;\n"], [819, "  dvi_vsync_reg <= dvi_vsync;\n"]]}}